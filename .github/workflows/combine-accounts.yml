name: Combine Account Data

on:
  push:
    paths:
      - 'accounts/*.json'
      - '!accounts/combined.json'
      - '!accounts/index.json'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  combine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-generate index.json and combine accounts
        run: |
          # Auto-detect all account files (exclude combined.json and index.json)
          ACCOUNT_FILES=$(ls accounts/*.json 2>/dev/null | grep -v 'combined.json' | grep -v 'index.json' || true)

          # Extract unique login IDs from filenames (format: {login}_{eaName}.json or {login}.json)
          declare -A LOGINS
          for FILE in $ACCOUNT_FILES; do
            BASENAME=$(basename "$FILE" .json)
            # Extract login ID (everything before first underscore, or whole name if no underscore)
            LOGIN_ID=$(echo "$BASENAME" | cut -d'_' -f1)
            LOGINS[$LOGIN_ID]=1
          done

          # Generate index.json with unique login IDs
          echo '{' > accounts/index.json
          echo '  "accounts": [' >> accounts/index.json
          FIRST=true
          for LOGIN_ID in "${!LOGINS[@]}"; do
            if [ "$FIRST" = true ]; then
              FIRST=false
              echo "    \"$LOGIN_ID\"" >> accounts/index.json
            else
              echo "    ,\"$LOGIN_ID\"" >> accounts/index.json
            fi
          done
          echo '  ]' >> accounts/index.json
          echo '}' >> accounts/index.json

          # Pretty print and sort index.json
          cat accounts/index.json | jq '.accounts |= sort' > accounts/index_temp.json
          mv accounts/index_temp.json accounts/index.json

          echo "Generated index.json with accounts: ${!LOGINS[@]}"

          # Build combined.json - group by login ID
          # Use node.js for complex JSON manipulation
          node << 'NODEJS'
          const fs = require('fs');
          const path = require('path');

          const accountsDir = 'accounts';
          const files = fs.readdirSync(accountsDir)
            .filter(f => f.endsWith('.json') && f !== 'combined.json' && f !== 'index.json');

          // Group files by login ID
          const accountsMap = {};

          for (const file of files) {
            const filePath = path.join(accountsDir, file);
            const content = JSON.parse(fs.readFileSync(filePath, 'utf8'));

            // Extract login ID from filename or content
            const loginId = content.login ? String(content.login) : file.split('_')[0].replace('.json', '');

            if (!accountsMap[loginId]) {
              accountsMap[loginId] = {
                login: parseInt(loginId),
                server: content.server || '',
                currency: content.currency || '',
                balance: content.balance || 0,
                equity: content.equity || 0,
                margin: content.margin || 0,
                free_margin: content.free_margin || 0,
                margin_level: content.margin_level || 0,
                profit: content.profit || 0,
                last_updated: content.last_updated || '',
                active_eas: []
              };
            }

            // Update account data with latest values
            const acc = accountsMap[loginId];
            if (content.last_updated > acc.last_updated) {
              acc.last_updated = content.last_updated;
              acc.balance = content.balance;
              acc.equity = content.equity;
              acc.margin = content.margin;
              acc.free_margin = content.free_margin;
              acc.margin_level = content.margin_level;
              acc.profit = content.profit;
              acc.server = content.server;
              acc.currency = content.currency;
            }

            // Add EA to active_eas list
            const eaName = content.ea_name || content.name || file.split('_').slice(1).join('_').replace('.json', '') || 'Unknown';
            if (!acc.active_eas.includes(eaName)) {
              acc.active_eas.push(eaName);
            }
          }

          // Convert to array and sort
          const accounts = Object.values(accountsMap)
            .map(acc => ({
              id: String(acc.login),
              login: acc.login,
              server: acc.server,
              currency: acc.currency,
              balance: acc.balance,
              equity: acc.equity,
              margin: acc.margin,
              free_margin: acc.free_margin,
              margin_level: acc.margin_level,
              profit: acc.profit,
              last_updated: acc.last_updated,
              active_eas: acc.active_eas.sort()
            }))
            .sort((a, b) => a.login - b.login);

          // Find latest timestamp
          const latestTimestamp = accounts.reduce((latest, acc) =>
            acc.last_updated > latest ? acc.last_updated : latest, '');

          const combined = {
            last_updated: latestTimestamp,
            accounts: accounts
          };

          fs.writeFileSync(path.join(accountsDir, 'combined.json'), JSON.stringify(combined, null, 2));
          console.log('Generated combined.json with', accounts.length, 'accounts');
          NODEJS

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add accounts/index.json accounts/combined.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-update index and combine account data"
            git push
          fi
